{% extends "base.html" %}

{% block title %}{{ slideshow.name }} - Photo Frame Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-start mb-4">
    <div>
        <h1>{{ slideshow.name }}</h1>
        <p class="text-muted mb-0">
            {{ slideshow.screen_width }}×{{ slideshow.screen_height }} • 
            Created {{ slideshow.created_at.strftime('%B %d, %Y at %H:%M') }}
        </p>
    </div>
    <div>
        {% if slideshow.status == 'completed' %}
            <span class="badge bg-success fs-6">Completed</span>
        {% elif slideshow.status == 'processing' %}
            <span class="badge bg-primary fs-6">Processing</span>
        {% elif slideshow.status == 'error' %}
            <span class="badge bg-danger fs-6">Error</span>
        {% else %}
            <span class="badge bg-secondary fs-6">{{ slideshow.status|title }}</span>
        {% endif %}
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Processing Status -->
        {% if slideshow.status == 'processing' %}
        <div class="processing-info" id="processingInfo">
            <h5><i class="fas fa-cog fa-spin"></i> Processing in Progress</h5>
            <p class="mb-3">Your slideshow is being processed. This may take several minutes for large photo collections.</p>
            
            <div class="progress mb-3">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" 
                     style="width: {{ slideshow.progress }}%" 
                     id="progressBar">
                    {{ slideshow.progress }}%
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <strong>Images Found:</strong> 
                    <span id="totalImages">{{ slideshow.total_images or 'Scanning...' }}</span>
                </div>
                <div class="col-md-6">
                    <strong>Images Processed:</strong> 
                    <span id="processedImages">{{ slideshow.processed_images }}</span>
                </div>
            </div>
            
            <div class="mt-3">
                <div class="d-flex align-items-center mb-2">
                    <strong class="me-2">Status:</strong>
                    <span id="processingMessage" class="text-info">
                        Processing will continue in the background. You can close this page and come back later.
                    </span>
                </div>
                <div id="currentImageContainer" style="display: none;">
                    <strong>Current Image:</strong>
                    <span id="currentImage" class="font-monospace text-muted"></span>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Error Message -->
        {% if slideshow.status == 'error' %}
        <div class="alert alert-danger">
            <h5><i class="fas fa-exclamation-triangle"></i> Processing Error</h5>
            <p class="mb-0">{{ slideshow.error_message }}</p>
            <hr>
            <p class="mb-0">
                <small>
                    You can try deleting this slideshow and creating a new one. 
                    Make sure your ZIP file contains valid image files (JPG, PNG, BMP, TIFF).
                </small>
            </p>
        </div>
        {% endif %}

        <!-- Completion Info -->
        {% if slideshow.status == 'completed' %}
        <div class="alert alert-success">
            <h5><i class="fas fa-check-circle"></i> Processing Complete!</h5>
            <p class="mb-0">
                Successfully processed {{ slideshow.processed_images }} images out of {{ slideshow.total_images }} found.
                {% if slideshow.completed_at %}
                    Completed on {{ slideshow.completed_at.strftime('%B %d, %Y at %H:%M') }}.
                {% endif %}
            </p>
        </div>
        {% endif %}

        <!-- Slideshow Details -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> Slideshow Details</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Screen Resolution:</strong><br>
                        {{ slideshow.screen_width }} × {{ slideshow.screen_height }} pixels
                    </div>
                    <div class="col-md-6">
                        <strong>Image Rotation:</strong><br>
                        Every {{ slideshow.rotation_interval }} seconds
                    </div>
                </div>
                
                {% if slideshow.weather_zip %}
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Weather Location:</strong><br>
                        ZIP {{ slideshow.weather_zip }}
                    </div>
                    <div class="col-md-6">
                        <strong>Weather API:</strong><br>
                        {% if slideshow.weather_api_key and slideshow.weather_api_key != 'YOUR_API_KEY_HERE' %}
                            <span class="text-success">Configured</span>
                        {% else %}
                            <span class="text-muted">Not configured</span>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                {% if slideshow.zip_filename %}
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Original File:</strong><br>
                        {{ slideshow.zip_filename.split('_', 1)[1] if '_' in slideshow.zip_filename else slideshow.zip_filename }}
                    </div>
                    <div class="col-md-6">
                        <strong>File Size:</strong><br>
                        {% if slideshow.zip_size %}
                            {{ "%.1f"|format(slideshow.zip_size / 1024 / 1024) }} MB
                        {% else %}
                            Unknown
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Access URLs -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-link"></i> Access URLs</h5>
                {% if slideshow.status == 'completed' %}
                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#generateUrlModal">
                    <i class="fas fa-plus"></i> Add URL
                </button>
                {% endif %}
            </div>
            <div class="card-body">
                {% if slideshow.urls %}
                    <div class="url-list">
                        {% for url in slideshow.urls %}
                        <div class="url-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    {% if url.name %}
                                        <strong>{{ url.name }}</strong><br>
                                    {% endif %}
                                    <small class="text-muted font-monospace">
                                        {{ url.url_key[:32] }}...
                                    </small><br>
                                    <small class="text-muted">
                                        {% if url.access_count %}
                                            {{ url.access_count }} views
                                        {% else %}
                                            No views yet
                                        {% endif %}
                                        • Created {{ url.created_at.strftime('%m/%d/%Y') }}
                                    </small>
                                </div>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li>
                                            <a class="dropdown-item" href="{{ url_for('view_slideshow', url_key=url.url_key) }}" target="_blank">
                                                <i class="fas fa-play"></i> Open Slideshow
                                            </a>
                                        </li>
                                        <li>
                                            <button class="dropdown-item" onclick="copyToClipboard('{{ request.url_root }}s/{{ url.url_key }}')">
                                                <i class="fas fa-copy"></i> Copy URL
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted text-center">
                        {% if slideshow.status == 'completed' %}
                            No access URLs generated yet.<br>
                            <button class="btn btn-sm btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#generateUrlModal">
                                Generate First URL
                            </button>
                        {% else %}
                            URLs will be available after processing completes.
                        {% endif %}
                    </p>
                {% endif %}
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-tools"></i> Actions</h5>
            </div>
            <div class="card-body d-grid gap-2">
                <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
                {% if slideshow.status == 'completed' and slideshow.urls %}
                <a href="{{ url_for('view_slideshow', url_key=slideshow.urls[0].url_key) }}" 
                   class="btn btn-success" target="_blank">
                    <i class="fas fa-play"></i> View Slideshow
                </a>
                {% endif %}
                <form method="POST" action="{{ url_for('delete_slideshow', slideshow_id=slideshow.id) }}" 
                      onsubmit="return confirm('Are you sure you want to delete this slideshow and all its URLs?')">
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="fas fa-trash"></i> Delete Slideshow
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Generate URL Modal -->
<div class="modal fade" id="generateUrlModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('generate_url', slideshow_id=slideshow.id) }}">
                <div class="modal-header">
                    <h5 class="modal-title">Generate New Access URL</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="url_name" class="form-label">URL Name (Optional)</label>
                        <input type="text" class="form-control" id="url_name" name="url_name" 
                               placeholder="e.g., For Family, For Friends">
                        <div class="form-text">Give this URL a memorable name to help you organize multiple URLs</div>
                    </div>
                    <div class="alert alert-info">
                        <small>
                            <i class="fas fa-info-circle"></i>
                            A secure 256-character random key will be generated for this URL.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Generate URL</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        // Show success message
        const toast = document.createElement('div');
        toast.className = 'position-fixed top-0 end-0 p-3';
        toast.style.zIndex = '1050';
        toast.innerHTML = `
            <div class="toast show" role="alert">
                <div class="toast-body">
                    <i class="fas fa-check text-success"></i> URL copied to clipboard!
                </div>
            </div>
        `;
        document.body.appendChild(toast);
        setTimeout(() => document.body.removeChild(toast), 3000);
    });
}

// WebSocket connection for real-time updates
document.addEventListener('DOMContentLoaded', function() {
    const slideshowId = {{ slideshow.id }};
    const status = '{{ slideshow.status }}';
    
    if (status === 'processing') {
        // Connect to WebSocket for live updates
        const socket = io();
        
        socket.on('connect', function() {
            socket.emit('join_slideshow', {slideshow_id: slideshowId});
        });
        
        socket.on('progress_update', function(data) {
            if (data.slideshow_id === slideshowId) {
                // Update progress bar
                const progressBar = document.getElementById('progressBar');
                if (progressBar) {
                    progressBar.style.width = data.progress + '%';
                    progressBar.textContent = data.progress + '%';
                }
                
                // Update message
                const messageElement = document.getElementById('processingMessage');
                if (messageElement && data.message) {
                    messageElement.textContent = data.message;
                    
                    // Color code based on message content
                    messageElement.className = 'text-info'; // default
                    if (data.message.includes('✓ Processed')) {
                        messageElement.className = 'text-success';
                    } else if (data.message.includes('⚠ Skipped') || data.message.includes('❌ Error')) {
                        messageElement.className = 'text-warning';
                    } else if (data.message.includes('Processing image')) {
                        messageElement.className = 'text-primary';
                    }
                }
                
                // Update current image if provided
                if (data.current_image) {
                    const currentImageContainer = document.getElementById('currentImageContainer');
                    const currentImageElement = document.getElementById('currentImage');
                    if (currentImageContainer && currentImageElement) {
                        currentImageElement.textContent = data.current_image;
                        currentImageContainer.style.display = 'block';
                    }
                } else {
                    // Hide current image container if no current image
                    const currentImageContainer = document.getElementById('currentImageContainer');
                    if (currentImageContainer) {
                        currentImageContainer.style.display = 'none';
                    }
                }
                
                // Update counts if available
                if (data.total_images !== undefined) {
                    const totalElement = document.getElementById('totalImages');
                    if (totalElement) totalElement.textContent = data.total_images;
                }
                if (data.processed_images !== undefined) {
                    const processedElement = document.getElementById('processedImages');
                    if (processedElement) processedElement.textContent = data.processed_images;
                }
                
                // Reload page if completed or error
                if (data.status === 'completed' || data.status === 'error') {
                    setTimeout(() => location.reload(), 2000);
                }
            }
        });
    }
});
</script>
{% endblock %}